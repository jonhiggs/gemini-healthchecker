#!/usr/bin/env bash

ROOT_DIR="$(dirname "$0")/.."
CONFIG=${ROOT_DIR}/etc/endpoints.json

ENDPOINT_IDS=( $(jq -r .[].id "${CONFIG}") )

(
  echo -e "target\tfailures\tlast test\tlast success"
  for i in ${ENDPOINT_IDS[@]}; do
    target=$(jq -r --arg i $i '.[] | select(.id==$i) | .target' "${CONFIG}")
    failures=$(redis-cli --raw MGET F-$i)
    last_test=$(date -u --iso-8601=seconds --date=@$(redis-cli --raw MGET LT-$i) | sed 's/\+.*//')
    last_success=$(date -u --iso-8601=seconds --date=@$(redis-cli --raw MGET LS-$i) | sed 's/\+.*//')

    echo -e "${target}\t${failures}\t${last_test}\t${last_success}"
  done | sort
) | column -s $'\t' -t
