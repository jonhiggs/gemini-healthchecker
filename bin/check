#!/usr/bin/env bash
TARGET=$1
TIMEOUT=${2:-2}
RECHECKS=${3:-5}
RECHECK_INTERVAL=${4:-5}
HOST="$(echo "${TARGET}" | cut -d/ -f3 | sed 's/:[0-9]*$//')"
PORT="$(echo "${TARGET}" | cut -d/ -f3 | awk -F: '(NF==2){print $2} (NF==1){print 1965}')"
RUNDIR="${XDG_RUNTIME_DIR}/gemini-healthchecker/${HOST}:${PORT}"

set -euo pipefail

_usage()        { echo "Usage: $(basename "$0") TARGET [TIMEOUT] [RECHECKS] [RECHECK_INTERVAL]"; }
_is_up()        { [[ $(tail -n1 "${RUNDIR}/state") -eq 20 ]]; }
_is_down()      { ! _is_up; }
_was_up()       { [[ $(tail -n1 "${RUNDIR}/last_state") -eq 20 ]]; }
_was_down()     { ! _was_up; }
_last_success() { stat -c %Y "${RUNDIR}/last_success"; }
_print_date()   { date -u --iso-8601=seconds --date="${1:-now}"; }
_test_target()  { _gemini_status_code >> "${RUNDIR}/state"; }
_check_dep()    { command -v "$1" 2>/dev/null || _error "$1: command not found"; }
_error()        { echo "$@" >&2 && exit 1; }
_print_email()  { echo -e "Subject: $1\n\n$2"; }

_gemini_status_code() {
  _check_dep "openssl"
  echo -e "${TARGET}/\\r\\n" \
    | timeout "${TIMEOUT}" openssl s_client -connect "${HOST}:${PORT}" -ign_eof -quiet 2>/dev/null \
    | awk '(NR==1) {print $1; exit 0}' \
    || echo 0
}

[[ $# -eq 0 ]] || [[ $# -gt 4 ]] && _usage && exit 1
[[ "$*" =~ --help ]]             && _usage && exit 0
[[ -z "${XDG_RUNTIME_DIR}" ]]    && _error "XDG_RUNTIME_DIR is undefined"

mkdir -p "${RUNDIR}"
if [[ -f "${RUNDIR}/state" ]]; then
  mv "${RUNDIR}/state" "${RUNDIR}/last_state"
else
  echo 20 > "${RUNDIR}/last_state"  # assume it's ok
fi
touch "${RUNDIR}/state"

for ((i=0;i<RECHECKS;i++)); do
  _test_target
  _is_up && touch "${RUNDIR}/last_success" && break
  sleep "${RECHECK_INTERVAL}"
done

if _is_up && _was_down; then
  _print_email \
    "${TARGET} has recovered" \
    "${TARGET} has recovered since failing at $(_print_date "@$(_last_success)")"
elif _is_down && _was_up; then
  _print_email \
    "${TARGET} has failed" \
    "${TARGET} has entered an alarm state at $(_print_date)"
fi
